name: Create 5 VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        vps_index: [1, 2, 3, 4, 5]

    env:
      GDRIVE_ID: 14oOIs4DAA1HwzKDdyWV-eRQgYqD-l61_
      VPS_NAME: auto-restart-vps

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install & Run Bot
        run: |
          echo "ðŸš€ Starting VPS ${{ matrix.vps_index }}"
          python3 -m pip install --user gdown
          gdown --id "$GDRIVE_ID" -O setup.sh
          chmod +x setup.sh

          # Cháº¡y VPS vÃ  ghi log riÃªng cho tá»«ng instance
          nohup bash setup.sh > "vps_${{ matrix.vps_index }}.log" 2>&1 &

          echo "âœ… VPS ${{ matrix.vps_index }} started. Logs will appear below:"
          tail -f "vps_${{ matrix.vps_index }}.log" &

      - name: Keep VPS alive
        run: |
          echo "ðŸŸ¢ VPS ${{ matrix.vps_index }} is running..."
          while true; do
            date +"[%Y-%m-%d %H:%M:%S] VPS-${{ matrix.vps_index }} still alive..."
            sleep 60
          done
